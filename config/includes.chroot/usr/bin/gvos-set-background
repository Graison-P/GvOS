#!/bin/bash
# GvOS Dynamic Background Setter
# Sets wallpaper based on screen aspect ratio

# Get screen resolution using xrandr
RESOLUTION=$(xrandr --current | grep '*' | uniq | awk '{print $1}' | head -1)

if [ -z "$RESOLUTION" ]; then
    # Fallback to default widescreen if xrandr fails
    WALLPAPER="/usr/share/backgrounds/gvos-background1.jpg"
else
    # Parse resolution
    WIDTH=$(echo "$RESOLUTION" | cut -d'x' -f1)
    HEIGHT=$(echo "$RESOLUTION" | cut -d'x' -f2)
    
    # Calculate aspect ratio (multiply by 100 to avoid floating point)
    # 4:3 ratio = 1.333... (133)
    # 16:9 ratio = 1.777... (177)
    # 16:10 ratio = 1.6 (160)
    RATIO=$((WIDTH * 100 / HEIGHT))
    
    # Check if aspect ratio is close to 4:3 (between 1.25 and 1.4, i.e., 125-140)
    if [ "$RATIO" -ge 125 ] && [ "$RATIO" -le 140 ]; then
        WALLPAPER="/usr/share/backgrounds/gvos-background2.jpg"
    else
        # Widescreen (16:9, 16:10, ultrawide, etc.)
        WALLPAPER="/usr/share/backgrounds/gvos-background1.jpg"
    fi
fi

# Set wallpaper using xfconf-query for XFCE
if command -v xfconf-query &> /dev/null; then
    # Update XFCE desktop wallpaper
    xfconf-query -c xfce4-desktop -p /backdrop/screen0/monitor0/workspace0/last-image -s "$WALLPAPER" 2>/dev/null || true
    
    # Also try for multiple monitors
    for monitor in $(xfconf-query -c xfce4-desktop -l | grep -E 'monitor.*last-image$'); do
        xfconf-query -c xfce4-desktop -p "$monitor" -s "$WALLPAPER" 2>/dev/null || true
    done
fi

# Fallback: try other methods
if command -v feh &> /dev/null; then
    feh --bg-scale "$WALLPAPER" &
elif command -v nitrogen &> /dev/null; then
    nitrogen --set-scaled "$WALLPAPER" &
fi
